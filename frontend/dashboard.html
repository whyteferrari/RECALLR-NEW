<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recallr - Study Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Manjari:wght@100;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>
  
  <!-- Sidebar Component -->
  <aside class="sidebar glass">
    <div class="sidebar__logo">Recallr</div>
    
    <div class="sidebar__divider"></div>
    
    <a href="adddeck.html" class="sidebar__button">Add Deck</a>
    <a href="#" class="sidebar__button coming-soon">Add Folder</a>
    
    <div class="sidebar__divider"></div>
    
    <nav class="sidebar__nav">
      <a href="dashboard.html" class="sidebar__link">Home</a>
      <a href="library-ongoing.html" class="sidebar__link">My Library</a>
      <div class="sidebar__link coming-soon">Settings</div>
      <div class="sidebar__divider"></div>
      <div class="sidebar__link coming-soon">Public Decks</div>
      <div class="sidebar__link coming-soon">Public Folders</div>
      <div class="sidebar__divider"></div>
    </nav>
    
    <a href="login.html" class="sidebar__logout">Logout</a>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="header">
      <div class="header__text">
        <h1>Welcome back, <span id="usernameHeader">User</span>!</h1>
        <p>Ready to study?</p>
      </div>
      <div class="header__icons">
        <div class="icon-placeholder"></div>
        <div class="icon-placeholder"></div>
      </div>
    </header>

    <!-- Study Plan -->
    <section class="study-plan glass">
      <div class="study-plan__header">
        <div>
          <h2 class="study-plan__title">Today's Study Plan</h2>
          <p class="study-plan__date" id="studyPlanDate"></p>
        </div>
        <button class="study-plan__add-btn">Add Task</button>
      </div>
      <div class="task-list" id="taskList">
        <!-- Tasks will be injected dynamically -->
      </div>
    </section>

    <!-- Grid Section -->
    <div class="grid-section">
      <!-- Streaks -->
      <section class="streaks glass">
        <h2 class="streaks__title">Streaks</h2>
        <p class="streaks__subtitle">Start studying to have a streak!</p>
        <div class="streaks__calendar" id="streakCalendar">
          <!-- Calendar generated by JS -->
        </div>
      </section>

      <!-- Quick Notes -->
      <section class="quick-notes glass">
        <div class="quick-notes__header">
          <h2 class="quick-notes__title">Quick Notes</h2>
          <button class="quick-notes__edit-btn coming-soon">Edit Notes</button>
        </div>
        <div class="quick-notes__lines" id="quickNotesLines">
          <!-- Lines generated by JS -->
        </div>
      </section>
    </div>

    <!-- Recently Studied -->
    <section class="recently-studied glass">
      <h2 class="recently-studied__title">Recently Studied</h2>
      <div class="deck-grid" id="recentDeckGrid">
        <!-- Decks injected dynamically -->
      </div>
    </section>
  </main>

  <!-- Add Task Modal -->
  <div class="modal" id="addTaskModal">
    <div class="modal__content">
      <div class="modal__header">
        <h2 class="modal__title">Add New Task</h2>
        <button class="modal__close" id="closeModal">×</button>
      </div>
      <form class="modal__form" id="addTaskForm">
        <div class="form__group">
          <label class="form__label" for="deckSelect">Select Deck</label>
          <select class="form__select" id="deckSelect" required>
            <option value="">Choose a deck...</option>
          </select>
        </div>
        <div class="form__group">
          <label class="form__label" for="taskTime">Study Time</label>
          <input type="time" class="form__input" id="taskTime" required>
        </div>
        <div class="form__group">
          <label class="form__label">Color Tag</label>
          <div class="color-picker">
            <input type="color" class="color-input" id="colorInput" value="#5D9CFF">
            <div class="color-preview" id="colorPreview">#5D9CFF</div>
          </div>
        </div>
        <div class="modal__actions">
          <button type="button" class="btn btn--secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn--primary">Add Task</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Notes Modal -->
  <div class="modal" id="editNotesModal">
    <div class="modal__content">
      <div class="modal__header">
        <h2 class="modal__title">Edit Quick Notes</h2>
        <button class="modal__close" id="closeNotesModal">×</button>
      </div>
      <form class="modal__form" id="editNotesForm">
        <div class="form__group">
          <label class="form__label" for="notesEditor">Your Notes</label>
          <textarea class="form__input notes-editor" id="notesEditor" rows="10"></textarea>
        </div>
        <div class="modal__actions">
          <button type="button" class="btn btn--secondary" id="cancelNotesBtn">Cancel</button>
          <button type="submit" class="btn btn--primary">Save Notes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ✅ IMPORTANT: Load config.js FIRST -->
  <script src="./config.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
  // ==============================
  // Elements
  // ==============================
  const taskList = document.querySelector('.task-list');
  const deckSelect = document.getElementById('deckSelect');
  const colorInput = document.getElementById('colorInput');
  const colorPreview = document.getElementById('colorPreview');
  const addTaskModal = document.getElementById('addTaskModal');
  const addTaskBtn = document.querySelector('.study-plan__add-btn');
  const closeModalBtn = document.getElementById('closeModal');
  const cancelBtn = document.getElementById('cancelBtn');
  const addTaskForm = document.getElementById('addTaskForm');
  const studyPlanDate = document.querySelector('.study-plan__date');
  const headerUser = document.querySelector('.header__text h1');

  // ✅ FIXED: Use checkAuth helper
  const userId = checkAuth();
  if (!userId) {
    throw new Error('Not authenticated');
  }

  const username = localStorage.getItem('username') || 'User';
  let selectedColor = '#5D9CFF';

  // ==============================
  // Initialize page
  // ==============================
  headerUser.textContent = `Welcome back, ${username}!`;

  const now = new Date();
  studyPlanDate.textContent = `${now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} | ${now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;

  colorPreview.textContent = selectedColor.toUpperCase();

  // ==============================
  // Color input preview
  // ==============================
  colorInput.addEventListener('input', e => {
    selectedColor = e.target.value;
    colorPreview.textContent = selectedColor.toUpperCase();
  });

  // ==============================
  // Modal handling
  // ==============================
  const closeModal = () => {
    addTaskModal.classList.remove('modal--open');
    addTaskForm.reset();
    selectedColor = '#5D9CFF';
    colorInput.value = selectedColor;
    colorPreview.textContent = selectedColor.toUpperCase();
  };

  addTaskBtn.addEventListener('click', () => addTaskModal.classList.add('modal--open'));
  closeModalBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  addTaskModal.addEventListener('click', e => { if (e.target === addTaskModal) closeModal(); });

  // ==============================
  // Helper: format time
  // ==============================
  const formatTime = timeStr => {
    const [hourStr, minuteStr] = timeStr.split(':');
    const hour = parseInt(hourStr);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    return `${displayHour}:${minuteStr} ${ampm}`;
  };

  // ==============================
  // Task checkbox toggle - FIXED
  // ==============================
  const toggleTaskCompletion = async taskItem => {
    const taskId = taskItem.dataset.taskId;
    const completed = !taskItem.classList.contains('task-item--disabled');

    try {
      // ✅ FIXED: Use API_CONFIG
      const res = await fetch(API_CONFIG.ENDPOINTS.UPDATE_TASK(userId, taskId), {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ completed })
      });
      
      if (!res.ok) throw new Error('Failed to update task');
      
      taskItem.classList.toggle('task-item--disabled');
      const checkbox = taskItem.querySelector('.task-item__checkbox');
      checkbox.classList.toggle('task-item__checkbox--filled');
    } catch (err) {
      console.error('❌ Task update error:', err);
      alert('Could not update task.');
    }
  };

  const setupTaskCheckbox = taskItem => {
    const checkbox = taskItem.querySelector('.task-item__checkbox');
    checkbox.addEventListener('click', e => {
      e.stopPropagation();
      toggleTaskCompletion(taskItem);
    });
  };

  // ==============================
  // Load user decks - FIXED
  // ==============================
  const loadUserDecks = async () => {
    if (!deckSelect) return;
    try {
      // ✅ FIXED: Use API_CONFIG
      const res = await fetch(API_CONFIG.ENDPOINTS.GET_ONGOING_DECKS(userId));
      
      if (!res.ok) throw new Error('Failed to load decks');
      
      const decks = await res.json();
      deckSelect.innerHTML = `<option value="">Choose a deck...</option>`;
      
      decks.forEach(deck => {
        const option = document.createElement('option');
        option.value = deck.deck_id;
        option.textContent = deck.name;
        deckSelect.appendChild(option);
      });
      
      console.log('✅ Loaded', decks.length, 'decks');
    } catch (err) {
      console.error('❌ Failed to load decks:', err);
    }
  };

  // ==============================
  // Load tasks - FIXED
  // ==============================
  const loadTasks = async () => {
    if (!taskList) return;
    try {
      // ✅ FIXED: Use API_CONFIG
      const res = await fetch(API_CONFIG.ENDPOINTS.GET_TASKS(userId));
      
      if (!res.ok) throw new Error('Failed to load tasks');
      
      const tasks = await res.json();
      taskList.innerHTML = '';

      if (tasks.length === 0) {
        const placeholder = document.createElement('p');
        placeholder.className = 'empty-placeholder';
        placeholder.textContent = 'No study plans for today yet!';
        taskList.appendChild(placeholder);
        return;
      }

      tasks.forEach(task => {
        const taskDiv = document.createElement('div');
        taskDiv.className = `task-item glass ${task.completed ? 'task-item--disabled' : ''}`;
        taskDiv.dataset.taskId = task.task_id;
        taskDiv.innerHTML = `
          <div class="task-item__indicator" style="background: ${task.color};"></div>
          <div class="task-item__content">
            <div class="task-item__time">${formatTime(task.task_time)}</div>
            <div class="task-item__name">${task.deck_name}</div>
          </div>
          <div class="task-item__checkbox ${task.completed ? 'task-item__checkbox--filled' : ''}"></div>
          <div class="task-item__menu glass">
            <div class="task-item__menu-dot"></div>
            <div class="task-item__menu-dot"></div>
            <div class="task-item__menu-dot"></div>
          </div>
          <div class="dropdown-menu glass">
            <button class="dropdown-item archive">Delete</button>
          </div>
        `;
        setupTaskCheckbox(taskDiv);
        taskList.appendChild(taskDiv);
      });
      
      console.log('✅ Loaded', tasks.length, 'tasks');
    } catch (err) {
      console.error('❌ Failed to load tasks:', err);
    }
  };

  // ==============================
  // Add new task - FIXED
  // ==============================
  addTaskForm.addEventListener('submit', async e => {
    e.preventDefault();
    const deckId = deckSelect.value;
    const taskTimeValue = document.getElementById('taskTime').value;
    
    if (!deckId || !taskTimeValue) {
      alert('Please select a deck and time.');
      return;
    }

    try {
      // ✅ FIXED: Use API_CONFIG
      const res = await fetch(API_CONFIG.ENDPOINTS.ADD_TASK(userId), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          deck_id: deckId, 
          task_time: taskTimeValue, 
          color: selectedColor 
        })
      });
      
      if (!res.ok) throw new Error('Failed to add task');
      
      await res.json();
      console.log('✅ Task added');
      closeModal();
      loadTasks();
    } catch (err) {
      console.error('❌ Failed to add task:', err);
      alert('Error adding task.');
    }
  });

  // ==============================
  // Delete task - FIXED
  // ==============================
  document.addEventListener('click', async e => {
    if (e.target.classList.contains('archive')) {
      const taskItem = e.target.closest('.task-item');
      const taskId = taskItem?.dataset.taskId;
      if (!taskId) return;
      
      if (!confirm('Delete this task?')) return;
      
      try {
        // ✅ FIXED: Use API_CONFIG
        const res = await fetch(API_CONFIG.ENDPOINTS.DELETE_TASK(userId, taskId), { 
          method: 'DELETE' 
        });
        
        if (!res.ok) throw new Error('Failed to delete task');
        
        taskItem.remove();
        console.log('✅ Task deleted');
      } catch (err) {
        console.error('❌ Failed to delete task:', err);
        alert('Error deleting task.');
      }
    }
  });

  // ==============================
  // Task menu dropdown
  // ==============================
  document.addEventListener('click', e => {
    if (e.target.closest('.task-item__menu')) {
      const menuBtn = e.target.closest('.task-item__menu');
      const dropdown = menuBtn.parentElement.querySelector('.dropdown-menu');
      document.querySelectorAll('.dropdown-menu').forEach(d => {
        if (d !== dropdown) d.classList.remove('dropdown-menu--open');
      });
      dropdown.classList.toggle('dropdown-menu--open');
    } else if (!e.target.closest('.dropdown-menu')) {
      document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('dropdown-menu--open'));
    }
  });

  // ==============================
  // Coming soon alerts
  // ==============================
  document.querySelectorAll('.coming-soon').forEach(el => {
    el.addEventListener('click', e => {
      e.preventDefault();
      alert('Feature coming soon!');
    });
  });

  // ==============================
  // Initial load
  // ==============================
  loadUserDecks();
  loadTasks();
});
  </script>
</body>
</html>